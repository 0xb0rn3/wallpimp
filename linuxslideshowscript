#!/bin/bash

set -e

# Get wallpaper directory
read -p "Wallpaper directory: " WALLPAPER_DIR
WALLPAPER_DIR="${WALLPAPER_DIR/#\~/$HOME}"

# Validate directory
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "Directory not found: $WALLPAPER_DIR"
    exit 1
fi

# Auto-install dependencies
install_deps() {
    if command -v apt-get >/dev/null 2>&1; then
        sudo apt-get update -qq && sudo apt-get install -y feh
    elif command -v yum >/dev/null 2>&1; then
        sudo yum install -y feh
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y feh
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -S --noconfirm feh
    elif command -v zypper >/dev/null 2>&1; then
        sudo zypper install -y feh
    elif command -v apk >/dev/null 2>&1; then
        sudo apk add feh
    fi
}

# Check/install feh
if ! command -v feh >/dev/null 2>&1; then
    echo "Installing feh..."
    install_deps
fi

# Set wallpaper function
set_wallpaper() {
    local img="$1"
    
    # Try different desktop environments
    if command -v gsettings >/dev/null 2>&1; then
        gsettings set org.gnome.desktop.background picture-uri "file://$img" 2>/dev/null || true
    fi
    
    if command -v xfconf-query >/dev/null 2>&1; then
        xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/last-image -s "$img" 2>/dev/null || true
    fi
    
    if command -v dconf >/dev/null 2>&1; then
        dconf write /org/mate/desktop/background/picture-filename "'$img'" 2>/dev/null || true
        dconf write /org/cinnamon/desktop/background/picture-uri "'file://$img'" 2>/dev/null || true
    fi
    
    # Universal fallback
    feh --bg-scale "$img" 2>/dev/null || true
}

# Find wallpapers
find_wallpapers() {
    find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.bmp" -o -iname "*.gif" \) 2>/dev/null
}

# Main slideshow loop
echo "Starting slideshow from: $WALLPAPER_DIR"
echo "Press Ctrl+C to stop"

while true; do
    while IFS= read -r img; do
        [[ -f "$img" ]] || continue
        set_wallpaper "$img"
        echo "$(basename "$img")"
        sleep 300  # 5 minutes
    done < <(find_wallpapers | shuf)
done
